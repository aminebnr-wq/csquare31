<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CSQUARE¬≥ Admin Dashboard</title>
  <style>
    :root {
      --deep-purple: #231123;
      --pink: #c30f45;
      --dark-bg: #120916;
      --border-color: #c30f45;
      --text-light: #fff;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--dark-bg);
      color: var(--text-light);
      margin: 0;
      padding: 0;
    }

    .login-box, .dashboard {
      max-width: 420px;
      background: rgba(35, 17, 35, 0.6);
      border: 1px solid var(--border-color);
      padding: 2rem;
      border-radius: 20px;
      box-shadow: 0 0 25px rgba(195, 15, 69, 0.3);
      text-align: center;
      margin: 8% auto;
      transition: 0.3s;
    }

    h2 {
      color: var(--pink);
    }

    input {
      width: 90%;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 10px;
      border: 2px solid var(--pink);
      background: #1c0f1c;
      color: var(--text-light);
      font-size: 1rem;
    }

    button {
      background: linear-gradient(135deg, var(--deep-purple), var(--pink));
      color: #fff;
      border: none;
      padding: 0.8rem 2rem;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 700;
      transition: 0.3s;
      margin-top: 0.5rem;
    }

    button:hover {
      background: var(--pink);
      box-shadow: 0 0 20px var(--pink);
    }

    .dashboard {
      max-width: 1100px;
      margin-top: 4rem;
      padding: 2rem 3rem;
      background: rgba(35, 17, 35, 0.5);
      border: 1px solid var(--pink);
    }

    .stats {
      display: flex;
      justify-content: space-around;
      background: rgba(195, 15, 69, 0.15);
      border: 1px solid var(--pink);
      border-radius: 15px;
      padding: 1rem;
      margin-bottom: 1rem;
      font-size: 1.2rem;
    }

    #searchInput {
      width: 100%;
      padding: 0.8rem;
      border-radius: 10px;
      border: 2px solid var(--pink);
      background: #1a0f1b;
      color: var(--text-light);
      margin-bottom: 1rem;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 1rem;
    }

    .tab-btn {
      flex: 1;
      padding: 0.5rem;
      border-radius: 10px;
      cursor: pointer;
      border: 1px solid var(--pink);
      background: rgba(35, 17, 35, 0.3);
      color: var(--text-light);
      font-weight: 600;
      transition: 0.3s;
    }

    .tab-btn.active {
      background: var(--pink);
      color: #fff;
    }

    .table-container {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
      color: var(--text-light);
    }

    th, td {
      border: 1px solid var(--pink);
      padding: 0.7rem;
      text-align: left;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    th {
      background: rgba(195, 15, 69, 0.3);
    }

    td button {
      margin: 0 2px;
      padding: 0.3rem 0.5rem;
      font-size: 0.8rem;
      border-radius: 8px;
    }

    .logout-btn {
      background: #d90035;
      margin-top: 1rem;
    }

    .admin-logs, .app-logs {
      background: rgba(35, 17, 35, 0.5);
      padding: 1rem;
      border-radius: 15px;
      margin-top: 2rem;
      display: none;
    }

    #errorMsg {
      color: #ff4040;
      margin-top: 1rem;
    }

    .admin-section-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    @media (max-width: 768px) {
      .dashboard {
        padding: 1rem;
      }
      .stats {
        flex-direction: column;
        gap: 10px;
      }
      table {
        min-width: 500px;
      }
    }
  </style>
</head>

<body>
  <!-- LOGIN -->
  <div class="login-box" id="loginBox">
    <h2>Admin Login</h2>
    <input type="email" id="adminEmail" placeholder="Email">
    <input type="password" id="adminPassword" placeholder="Password">
    <button id="loginBtn">Login</button>
    <p id="errorMsg"></p>
  </div>

  <!-- DASHBOARD -->
  <div class="dashboard" id="dashboard" style="display:none;">
    <h2>CSQUARE¬≥ Admin Dashboard</h2>
    <div class="stats">
      <div>üß© Applications: <strong id="count">0</strong></div>
      <div>üëÄ Visitors: <strong id="visitsCount">0</strong></div>
    </div>

    <div class="admin-section-buttons">
      <button id="downloadBtn">‚¨áÔ∏è Download CSV</button>
      <button id="logsBtn" style="display:none;">üìú View Admin Logs</button>
      <button id="appLogsBtn" style="display:none;">üìã View Applications Logs</button>
    </div>

    <div class="tabs">
      <div class="tab-btn active" data-status="all">All</div>
      <div class="tab-btn" data-status="pending">Pending</div>
      <div class="tab-btn" data-status="accepted">Accepted ‚úÖ</div>
      <div class="tab-btn" data-status="rejected">Rejected ‚ùå</div>
      <div class="tab-btn" data-status="contacted">Contacted üìû</div>
    </div>

    <input type="text" id="searchInput" placeholder="üîç Search by name, email, major or skill...">

    <div class="table-container">
      <table id="appTable">
        <tr><th>Full Name</th><th>Email</th><th>Major</th><th>Skills</th><th>Motivation</th><th>Status</th><th>Actions</th></tr>
      </table>
    </div>

    <div class="admin-logs" id="adminLogs">
      <h3>Admin Login Activity</h3>
      <div class="table-container">
        <table id="logsTable">
          <tr><th>Email</th><th>IP Address</th><th>Timestamp</th><th>Device</th></tr>
        </table>
      </div>
    </div>

    <div class="app-logs" id="appLogs">
      <h3>Applications Logs</h3>
      <div class="table-container">
        <table id="appLogsTable">
          <tr><th>Action</th><th>Target Email</th><th>Performed By</th><th>Reason</th><th>Timestamp</th></tr>
        </table>
      </div>
    </div>

    <button class="logout-btn" id="logoutBtn">Logout</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, orderBy, query, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyALCOPIyEyT3DNh0jOIIqRXQ-KTUolJh7k",
      authDomain: "csquare3-club.firebaseapp.com",
      projectId: "csquare3-club",
      storageBucket: "csquare3-club.firebasestorage.app",
      messagingSenderId: "910428386089",
      appId: "1:910428386089:web:4e5b10d7d23b818547fd38"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const SUPER_ADMIN = "admin@csquare3.club";

    const loginBox = document.getElementById('loginBox');
    const dashboard = document.getElementById('dashboard');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const errorMsg = document.getElementById('errorMsg');
    const countEl = document.getElementById('count');
    const visitsEl = document.getElementById('visitsCount');
    const table = document.getElementById("appTable");
    const downloadBtn = document.getElementById('downloadBtn');
    const searchInput = document.getElementById('searchInput');
    const logsBtn = document.getElementById('logsBtn');
    const appLogsBtn = document.getElementById('appLogsBtn');
    const adminLogs = document.getElementById('adminLogs');
    const logsTable = document.getElementById('logsTable');
    const appLogs = document.getElementById('appLogs');
    const appLogsTable = document.getElementById('appLogsTable');
    const tabButtons = document.querySelectorAll('.tab-btn');

    let appData = [];
    let currentFilter = "all";

    // LOGIN
    loginBtn.addEventListener('click', async () => {
      const email = document.getElementById('adminEmail').value.trim();
      const password = document.getElementById('adminPassword').value.trim();

      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // Always log login for all admins
        let ipAddress = "Unknown";
        try {
          const res = await fetch("https://api.ipify.org?format=json");
          const d = await res.json();
          ipAddress = d.ip;
        } catch {}

        await addDoc(collection(db, "admin_logs"), {
          email: user.email,
          ip: ipAddress,
          timestamp: new Date(),
          userAgent: navigator.userAgent
        });

        errorMsg.textContent = '';
      } catch (error) {
        errorMsg.textContent = 'Invalid credentials ‚ùå';
      }
    });

    logoutBtn.addEventListener('click', async () => {
      await signOut(auth);
      dashboard.style.display = 'none';
      loginBox.style.display = 'block';
    });

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        loginBox.style.display = 'none';
        dashboard.style.display = 'block';
        if (user.email === SUPER_ADMIN) {
          logsBtn.style.display = 'inline-block';
          appLogsBtn.style.display = 'inline-block';
        }
        await loadApplications();
        await loadVisits();
      } else {
        dashboard.style.display = 'none';
        loginBox.style.display = 'block';
      }
    });

    async function loadApplications() {
      const snapshot = await getDocs(collection(db, "applications"));
      appData = [];
      snapshot.forEach(docSnap => {
        const d = docSnap.data();
        d.docId = docSnap.id;
        if (!d.status) d.status = "pending";
        if (!Array.isArray(d.skills)) d.skills = d.skills ? [d.skills] : [];
        appData.push(d);
      });
      renderTable(appData);
      countEl.textContent = appData.length;
    }

    async function loadVisits() {
      const visitsSnapshot = await getDocs(collection(db, "visits"));
      visitsEl.textContent = visitsSnapshot.size;
    }

    function renderTable(data) {
      const searchValue = searchInput.value.toLowerCase().trim();
      const filteredByStatus = data.filter(d => currentFilter === "all" || d.status === currentFilter);
      const finalData = filteredByStatus.filter(d =>
        d.fullName.toLowerCase().includes(searchValue) ||
        d.email.toLowerCase().includes(searchValue) ||
        (d.major && d.major.toLowerCase().includes(searchValue)) ||
        (d.skills && d.skills.join(", ").toLowerCase().includes(searchValue))
      );

      table.innerHTML = `
        <tr>
          <th>Full Name</th>
          <th>Email</th>
          <th>Major</th>
          <th>Skills</th>
          <th>Motivation</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      `;

      finalData.forEach(d => {
        const statusColor = {
          pending: '#9B59B6',
          accepted: '#28a745',
          rejected: '#dc3545',
          contacted: '#ffc107'
        }[d.status] || '#c30f45';

        const row = table.insertRow();
        row.innerHTML = `
          <td>${d.fullName}</td>
          <td>${d.email}</td>
          <td>${d.major || '-'}</td>
          <td>${(d.skills || []).join(", ")}</td>
          <td>${d.motivation || '-'}</td>
          <td style="color:${statusColor}; font-weight:bold; text-transform:capitalize;">
            ${d.status || "Pending"}
          </td>
          <td>
            <button class="accept-btn">‚úÖ</button>
            <button class="reject-btn">‚ùå</button>
            <button class="contact-btn">üìû</button>
            <button class="delete-btn">üóëÔ∏è</button>
          </td>
        `;

        const docRef = d.docId;

        const perform = async (action, update = {}, reason = "") => {
          if (action === "deleted") {
            await deleteDoc(doc(db, "applications", docRef));
          } else {
            if (Object.keys(update).length) await updateDoc(doc(db, "applications", docRef), update);
          }

          await addDoc(collection(db, "app_logs"), {
            action,
            performedBy: auth.currentUser ? auth.currentUser.email : "unknown",
            targetEmail: d.email,
            reason,
            timestamp: new Date()
          });

          if (update.status) d.status = update.status;
          if (action === "deleted") appData = appData.filter(a => a.docId !== docRef);
          renderTable(appData);
        };

        row.querySelector('.accept-btn').addEventListener('click', () => perform("accepted", { status: "accepted" }));
        row.querySelector('.reject-btn').addEventListener('click', () => perform("rejected", { status: "rejected" }));
        row.querySelector('.contact-btn').addEventListener('click', () => perform("contacted", { status: "contacted" }));
        row.querySelector('.delete-btn').addEventListener('click', async () => {
          const reason = prompt("Reason for deletion:");
          if (reason && reason.trim()) await perform("deleted", {}, reason.trim());
          else alert("Please provide a reason for deletion.");
        });
      });
    }

    searchInput.addEventListener('input', () => renderTable(appData));
    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        tabButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.status;
        renderTable(appData);
      });
    });

    logsBtn.addEventListener('click', async () => {
      const q = query(collection(db, "admin_logs"), orderBy("timestamp", "desc"));
      const snapshot = await getDocs(q);
      logsTable.innerHTML = '<tr><th>Email</th><th>IP Address</th><th>Timestamp</th><th>Device</th></tr>';
      snapshot.forEach(d => {
        const l = d.data();
        const date = l.timestamp
          ? (l.timestamp.seconds ? new Date(l.timestamp.seconds * 1000).toLocaleString() : new Date(l.timestamp).toLocaleString())
          : '-';
        logsTable.insertRow().innerHTML = `<td>${l.email}</td><td>${l.ip || "N/A"}</td><td>${date}</td><td>${l.userAgent || '-'}</td>`;
      });
      adminLogs.style.display = 'block';
      appLogs.style.display = 'none';
    });

    appLogsBtn.addEventListener('click', async () => {
      const q = query(collection(db, "app_logs"), orderBy("timestamp", "desc"));
      const snapshot = await getDocs(q);
      appLogsTable.innerHTML = '<tr><th>Action</th><th>Target Email</th><th>Performed By</th><th>Reason</th><th>Timestamp</th></tr>';
      snapshot.forEach(d => {
        const l = d.data();
        const date = l.timestamp
          ? (l.timestamp.seconds ? new Date(l.timestamp.seconds * 1000).toLocaleString() : new Date(l.timestamp).toLocaleString())
          : '-';
        appLogsTable.insertRow().innerHTML = `<td>${l.action}</td><td>${l.targetEmail || '-'}</td><td>${l.performedBy || '-'}</td><td>${l.reason || '-'}</td><td>${date}</td>`;
      });
      appLogs.style.display = 'block';
      adminLogs.style.display = 'none';
    });

    // ensure logs are created for every admin action (safety retry)
    // Note: already handled in perform(); here we just keep UI consistent.

  </script>
</body>
</html>
