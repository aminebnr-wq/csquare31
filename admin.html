<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CSQUARE¬≥ Agency ‚Äî Admin Dashboard</title>
  <style>
    :root{
      --deep-purple:#231123;
      --pink:#c30f45;
      --dark-bg:#120916;
      --card-bg: rgba(35,17,35,0.55);
      --accent: #c30f45;
      --muted: #bba6b6;
      --success: #28a745;
      --danger: #dc3545;
      --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(180deg,var(--dark-bg), #0b0610);
      color:#fff;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      min-height:100vh;
      padding:2rem;
    }
    .container{
      max-width:1200px;
      margin:0 auto;
    }

    /* Header */
    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:1rem;
      margin-bottom:1.25rem;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand img{ height:48px; filter: drop-shadow(0 0 10px var(--pink)); }
    .brand h1{ font-size:1.1rem; margin:0; color:var(--pink); }
    .controls{ display:flex; gap:8px; align-items:center; }

    /* Login box */
    .login-box{
      max-width:420px;
      margin:6vh auto;
      background:var(--card-bg);
      border:1px solid rgba(195,15,69,0.28);
      padding:2rem;
      border-radius:14px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.6);
      text-align:center;
    }
    .login-box h2{ margin:0 0 0.6rem 0; color:var(--pink); }
    .login-box input{
      width:100%;
      padding:0.9rem;
      margin:0.6rem 0;
      border-radius:10px;
      border:2px solid rgba(195,15,69,0.18);
      background:#1a0f17;
      color:#fff;
      font-size:0.95rem;
    }
    .login-box button{
      margin-top:0.6rem;
      padding:0.85rem 1.4rem;
      border-radius:40px;
      border:none;
      background:linear-gradient(135deg,var(--deep-purple),var(--pink));
      color:#fff;
      font-weight:700;
      cursor:pointer;
    }
    #errorMsg{ color:#ff6b6b; margin-top:0.6rem; min-height:1.2rem }

    /* Dashboard (hidden until login) */
    .dashboard{
      display:none;
      background: transparent;
    }
    .panel{
      background: var(--card-bg);
      border-radius:12px;
      padding:1rem;
      border:1px solid rgba(195,15,69,0.15);
      box-shadow: 0 8px 30px rgba(0,0,0,0.5);
    }

    .top-row{
      display:flex;
      gap:12px;
      margin-bottom:12px;
      align-items:center;
    }

    .stat{
      flex:1;
      padding:1rem;
      border-radius:10px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid rgba(195,15,69,0.06);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .stat strong{ font-size:1.4rem; color:var(--pink) }

    .actions{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .btn{
      padding:0.6rem 0.9rem;
      border-radius:10px;
      border:1px solid rgba(195,15,69,0.12);
      background:transparent;
      color:#fff;
      cursor:pointer;
      font-weight:600;
    }
    .btn.primary{ background:linear-gradient(135deg,var(--deep-purple),var(--pink)); box-shadow:0 6px 20px rgba(195,15,69,0.12); }
    .btn.ghost{ background:transparent; }
    .btn.warn{ background: linear-gradient(90deg,#ffb84d,#ffc107); color:#000; }
    .btn.danger{ background: linear-gradient(90deg,#ff6b6b,#dc3545); color:#fff; }

    /* search & tabs */
    .toolbar{
      display:flex;
      gap:12px;
      margin:12px 0;
      align-items:center;
      flex-wrap:wrap;
    }
    #searchInput{
      flex:1;
      padding:0.7rem 1rem;
      border-radius:10px;
      border:1px solid rgba(195,15,69,0.1);
      background:#120712;
      color:#fff;
      min-width:220px;
    }
    .tabs{ display:flex; gap:8px; }
    .tab{ padding:0.45rem 0.7rem; border-radius:8px; cursor:pointer; border:1px solid rgba(195,15,69,0.08); background:transparent; font-weight:600; }
    .tab.active{ background:var(--pink); color:#fff; box-shadow:0 8px 20px rgba(195,15,69,0.12); }

    /* table */
    .table-wrap{ margin-top:12px; overflow:auto; border-radius:10px; border:1px solid rgba(255,255,255,0.03); }
    table{ width:100%; border-collapse:collapse; min-width:980px; }
    th, td{ padding:0.75rem 0.8rem; text-align:left; border-bottom:1px solid rgba(255,255,255,0.03); font-size:0.95rem; color:#fff; }
    th{ position:sticky; top:0; background: linear-gradient(180deg, rgba(0,0,0,0.2), rgba(0,0,0,0.1)); color:var(--muted); font-weight:700; z-index:2; }
    tr:hover td{ background: linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); }

    .tag{ display:inline-block; padding:4px 8px; border-radius:8px; background:rgba(255,255,255,0.03); border:1px solid rgba(195,15,69,0.08); margin-right:6px; font-size:0.85rem; color:var(--pink) }

    .row-actions button{ margin-right:6px; }

    /* logs area */
    .logs{ margin-top:12px; display:flex; gap:12px; flex-direction:column; }
    .logs .panel{ padding:0.75rem; max-height:260px; overflow:auto; }

    /* toast */
    .toast-wrap{ position:fixed; right:18px; bottom:18px; z-index:9999; display:flex; flex-direction:column; gap:8px; align-items:flex-end; }
    .toast{ background:#111; padding:12px 14px; border-radius:10px; border:1px solid rgba(195,15,69,0.12); box-shadow:0 6px 20px rgba(0,0,0,0.6); color:#fff; font-weight:600; min-width:200px; }
    .toast.success{ border-left:6px solid var(--success); }
    .toast.error{ border-left:6px solid var(--danger); }
    .toast.info{ border-left:6px solid var(--pink); }

    /* small screens */
    @media(max-width:900px){
      .stat{ flex-direction:column; align-items:flex-start; gap:6px; }
      .table-wrap{ overflow:auto; }
      table{ min-width:800px; }
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- Header -->
    <div class="header">
      <div class="brand">
        <img src="images/logo1.png" alt="logo">
        <div>
          <h1>CSQUARE¬≥ Agency ‚Äî Admin</h1>
          <div style="font-size:0.85rem; color:var(--muted)">Single Page Dashboard</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn" id="refreshBtn" style="display:none" title="Refresh data">üîÑ Refresh</button>
        <button class="btn" id="exportBtn" style="display:none" title="Download CSV">‚¨áÔ∏è Export CSV</button>        
        <button class="btn" id="logoutBtnTop" style="display:none">Logout</button>
      </div>
    </div>

    <!-- LOGIN BOX -->
    <div class="login-box panel" id="loginBox">
      <h2>Admin Login</h2>
      <input id="adminEmail" type="email" placeholder="Email" />
      <input id="adminPassword" type="password" placeholder="Password" />
      <div style="display:flex; gap:8px; justify-content:center; align-items:center; margin-top:8px;">
        <button id="loginBtn" class="btn primary">Login</button>
      </div>
      <p id="errorMsg"></p>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="dashboard">

      <div class="top-row">
        <div class="stat panel">
          <div>
            <div style="font-size:0.9rem; color:var(--muted)">Service Requests</div>
            <strong id="count">0</strong>
            <div style="font-size:0.85rem; color:var(--muted)">Total requests</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:0.85rem; color:var(--muted)">Visits</div>
            <strong id="visitsCount">0</strong>
          </div>
        </div>

        <div style="flex:1" class="panel">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
            <div style="font-weight:700; color:var(--muted)">Quick Actions</div>
            <div style="display:flex; gap:8px;">
              <button class="btn" id="selectAllBtn">Select All</button>
              <button class="btn" id="markInProgressBulk">In Progress</button>
              <button class="btn" id="markCompleteBulk">Complete</button>
              <button class="btn danger" id="deleteBulkBtn">Delete</button>
            </div>
          </div>
        </div>
      </div>

      <!-- toolbar -->
      <div class="toolbar">
        <input id="searchInput" placeholder="üîç Search by client name, email, or service..." />
        <div class="tabs" id="tabs">
          <div class="tab active" data-status="all">All</div>
          <div class="tab" data-status="pending">Pending</div>
          <div class="tab" data-status="in progress">In Progress</div>
          <div class="tab" data-status="completed">Completed</div>
        </div>

        <div style="margin-left:auto; display:flex; gap:8px;">
          <button class="btn" id="newRequestsToggle">üîî New Alerts</button>
          <button class="btn ghost" id="showLogsBtn" style="display:none">üìú Logs</button>
        </div>
      </div>

      <!-- Table -->
      <div class="table-wrap panel" id="tablePanel">
        <table id="reqTable" aria-live="polite">
          <thead>
            <tr>
              <th style="width:40px"><input type="checkbox" id="masterCheckbox" /></th>
              <th>Client Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Service Tags</th>
              <th>Project Description</th>
              <th>Status</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="reqTbody"></tbody>
        </table>
      </div>

      <!-- Logs & small panels -->
      <div class="logs">
        <div class="panel" id="logsPanel" style="display:none;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:700; color:var(--muted)">Admin Logs</div>
            <button class="btn ghost" id="closeLogsBtn">Close</button>
          </div>
          <div id="logsList" style="margin-top:8px; max-height:260px; overflow:auto;"></div>
        </div>

        <div class="panel" id="appLogsPanel" style="display:none;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:700; color:var(--muted)">Application Logs</div>
            <button class="btn ghost" id="closeAppLogsBtn">Close</button>
          </div>
          <div id="appLogsList" style="margin-top:8px; max-height:260px; overflow:auto;"></div>
        </div>
      </div>
    </div>

  </div>

  <!-- Toast container -->
  <div class="toast-wrap" id="toastWrap" aria-live="polite"></div>

  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, addDoc, doc, deleteDoc, updateDoc,
      onSnapshot, query, orderBy, where, getDoc
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

    // ---------- CONFIG ----------
    const firebaseConfig = {
      apiKey: "AIzaSyALCOPIyEyT3DNh0jOIIqRXQ-KTUolJh7k",
      authDomain: "csquare3-club.firebaseapp.com",
      projectId: "csquare3-club",
      storageBucket: "csquare3-club.firebasestorage.app",
      messagingSenderId: "910428386089",
      appId: "1:910428386089:web:4e5b10d7d23b818547fd38",
      measurementId: "G-6RTLYLFV11"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ---------- CONSTANTS ----------
    const SERVICE_COLLECTION = "applications";
    const ADMIN_LOGS_COLLECTION = "admin_logs";
    const APP_LOGS_COLLECTION = "app_logs";
    const VISITS_COLLECTION = "visits";
    const SUPER_ADMIN = "admin@csquare3.club"; // super admin email

    // ---------- UI ELEMENTS ----------
    const loginBox = document.getElementById('loginBox');
    const dashboard = document.getElementById('dashboard');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtnTop = document.getElementById('logoutBtnTop');
    const errorMsg = document.getElementById('errorMsg');

    const countEl = document.getElementById('count');
    const visitsEl = document.getElementById('visitsCount');
    const reqTbody = document.getElementById('reqTbody');

    const searchInput = document.getElementById('searchInput');
    const tabs = document.querySelectorAll('.tab');

    const refreshBtn = document.getElementById('refreshBtn');
    const exportBtn = document.getElementById('exportBtn');
    const masterCheckbox = document.getElementById('masterCheckbox');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const markInProgressBulk = document.getElementById('markInProgressBulk');
    const markCompleteBulk = document.getElementById('markCompleteBulk');
    const deleteBulkBtn = document.getElementById('deleteBulkBtn');

    const newRequestsToggle = document.getElementById('newRequestsToggle');
    const showLogsBtn = document.getElementById('showLogsBtn');
    const logsPanel = document.getElementById('logsPanel');
    const logsList = document.getElementById('logsList');
    const closeLogsBtn = document.getElementById('closeLogsBtn');

    const appLogsPanel = document.getElementById('appLogsPanel');
    const appLogsList = document.getElementById('appLogsList');
    const closeAppLogsBtn = document.getElementById('closeAppLogsBtn');

    const logoutTop = document.getElementById('logoutBtnTop');

    const toastWrap = document.getElementById('toastWrap');

    // state
    let requests = []; // local cache
    let knownIds = new Set();
    let currentFilter = 'all';
    let currentUser = null;
    let isSuper = false;
    let alertsEnabled = true;

    // small beep using WebAudio
    function playBeep() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.value = 880;
        g.gain.value = 0.05;
        o.connect(g);
        g.connect(ctx.destination);
        o.start();
        setTimeout(()=>{ o.stop(); ctx.close(); }, 180);
      } catch(e){ /* ignore */ }
    }

    // toast helper
    function toast(message, type='info', timeout=3500) {
      const t = document.createElement('div');
      t.className = 'toast ' + (type || 'info');
      t.textContent = message;
      toastWrap.appendChild(t);
      setTimeout(()=>{ t.style.opacity = '1'; }, 50);
      setTimeout(()=>{ t.style.opacity = '0'; t.addEventListener('transitionend', ()=> t.remove()); }, timeout);
    }


    loginBtn.addEventListener('click', async () => {
      const email = document.getElementById('adminEmail').value.trim();
      const password = document.getElementById('adminPassword').value.trim();
      if(!email || !password){ errorMsg.textContent = 'Enter credentials.'; return; }
      try {
        const userCred = await signInWithEmailAndPassword(auth, email, password);
        errorMsg.textContent = '';
        // add admin log
        let ip = 'Unknown';
        try { const r = await fetch('https://api.ipify.org?format=json'); const j = await r.json(); ip = j.ip || ip; } catch(e){}
        await addDoc(collection(db, ADMIN_LOGS_COLLECTION), { email: userCred.user.email, ip, timestamp: new Date(), userAgent: navigator.userAgent });
      } catch(e) {
        errorMsg.textContent = 'Invalid credentials ‚ùå';
      }
    });

    logoutTop.addEventListener('click', async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if(user) {
        isSuper = (user.email === SUPER_ADMIN);
        loginBox.style.display = 'none';
        dashboard.style.display = 'block';
        logoutTop.style.display = 'inline-block';
        showLogsBtn.style.display = isSuper ? 'inline-block' : 'none';
        refreshBtn.style.display = 'inline-block';
        exportBtn.style.display = 'inline-block';
        // initial load and setup real-time listener
        await loadVisits();
        await initialLoadAndListen();
        toast('Welcome back, ' + (user.email || 'admin') + ' ‚úÖ', 'success', 2400);
      } else {
        loginBox.style.display = 'block';
        dashboard.style.display = 'none';
        logoutTop.style.display = 'none';
        refreshBtn.style.display = 'none';
        exportBtn.style.display = 'none';

      }
    });

    // ---------- DATA LOADING ----------
    // initial one-time load + set up real-time onSnapshot
    async function initialLoadAndListen() {
      // fetch once
      await fetchAllRequests();

      // set up real-time listener for collection changes
      const q = query(collection(db, SERVICE_COLLECTION), orderBy('timestamp','desc'));
      onSnapshot(q, (snapshot) => {
        let changed = false;
        snapshot.docChanges().forEach(ch => {
          const docId = ch.doc.id;
          const d = ch.doc.data();
          d.docId = docId;
          // convert timestamp to Date if needed
          if(d.timestamp && d.timestamp.seconds) d._createdAt = new Date(d.timestamp.seconds*1000);
          else d._createdAt = d.timestamp ? new Date(d.timestamp) : new Date();

          if(ch.type === 'added') {
            // new doc - if unseen, notify
            if(!knownIds.has(docId)) {
              knownIds.add(docId);
              requests.unshift(d);
              toast('New Request: ' + (d.clientName || '‚Äî'), 'info', 5000);
              if(alertsEnabled) playBeep();
              changed = true;
            }
          } else if(ch.type === 'modified') {
            // update local
            const idx = requests.findIndex(r => r.docId === docId);
            if(idx > -1) { requests[idx] = {...requests[idx], ...d}; changed = true; }
          } else if(ch.type === 'removed') {
            requests = requests.filter(r => r.docId !== docId); knownIds.delete(docId); changed = true;
          }
        });
        if(changed) renderTable();
        // update counts
        countEl.textContent = requests.length;
      }, (err) => {
        console.error('Realtime error', err);
        toast('Realtime listener error', 'error', 3500);
      });
    }

    // one-time fetch (populate knownIds)
    async function fetchAllRequests() {
      const snapshot = await getDocs(query(collection(db, SERVICE_COLLECTION), orderBy('timestamp','desc')));
      requests = [];
      knownIds = new Set();
      snapshot.forEach(s => {
        const d = s.data();
        d.docId = s.id;
        if(d.timestamp && d.timestamp.seconds) d._createdAt = new Date(d.timestamp.seconds*1000);
        else d._createdAt = d.timestamp ? new Date(d.timestamp) : new Date();
        requests.push(d);
        knownIds.add(s.id);
      });
      countEl.textContent = requests.length;
      renderTable();
    }

    async function loadVisits() {
      try {
        const vs = await getDocs(collection(db, VISITS_COLLECTION));
        visitsEl.textContent = vs.size;
      } catch(e) { visitsEl.textContent = '0'; }
    }


    // ---------- RENDERING ----------
    function renderTable() {
      const q = searchInput.value.trim().toLowerCase();
      const filtered = requests.filter(r => {
        const stat = (r.status || 'pending').toLowerCase();
        if(currentFilter !== 'all' && stat !== currentFilter) return false;
        if(!q) return true;
        const hay = `${r.fullName || ''} ${r.email || ''} ${(r.services||[]).join(' ')} ${r.motivation||''}`.toLowerCase();
        return hay.includes(q);
      });

      // table body
      reqTbody.innerHTML = '';
      filtered.forEach(r => {
        const tr = document.createElement('tr');

        // checkbox
        const chTd = document.createElement('td');
        chTd.style.width = '40px';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.className = 'row-checkbox';
        cb.dataset.id = r.docId;
        chTd.appendChild(cb);
        tr.appendChild(chTd);

        // client name
        const nameTd = document.createElement('td'); nameTd.textContent = r.fullName || '-'; tr.appendChild(nameTd);
        const emailTd = document.createElement('td'); emailTd.textContent = r.email || '-'; tr.appendChild(emailTd);
        const phoneTd = document.createElement('td'); phoneTd.textContent = r.phone || '-'; tr.appendChild(phoneTd);

        // service tags
        const tagsTd = document.createElement('td');
        (r.services||[]).forEach(t => {
          const span = document.createElement('span');
          span.className = 'tag';
          span.textContent = t;
          tagsTd.appendChild(span);
        });

        tr.appendChild(tagsTd);

        const projTd = document.createElement('td');
        projTd.textContent = r.motivation
          ? (r.motivation.length > 120 ? r.motivation.slice(0,117) + '...' : r.motivation)
          : '-';
        tr.appendChild(projTd);

        const statusTd = document.createElement('td');
        const st = (r.status || 'pending');
        statusTd.innerHTML = `<strong style="color:${st==='pending'? 'var(--muted)': st==='in progress' ? '#ffc107' : st==='completed' ? 'var(--success)' : 'var(--danger)'}; text-transform:capitalize">${st}</strong>`;
        tr.appendChild(statusTd);

        const dateTd = document.createElement('td');
        const dts = r._createdAt ? r._createdAt.toLocaleString() : '-';
        dateTd.textContent = dts;
        tr.appendChild(dateTd);

        // actions
        const actionsTd = document.createElement('td');
        actionsTd.className = 'row-actions';

        const inProgressBtn = document.createElement('button');
        inProgressBtn.className = 'btn';
        inProgressBtn.textContent = '‚û°Ô∏è In Progress';
        inProgressBtn.addEventListener('click', () => changeStatus(r.docId, 'in progress'));

        const completeBtn = document.createElement('button');
        completeBtn.className = 'btn';
        completeBtn.textContent = '‚úîÔ∏è Complete';
        completeBtn.addEventListener('click', () => changeStatus(r.docId, 'completed'));

        const rejectBtn = document.createElement('button');
        rejectBtn.className = 'btn danger';
        rejectBtn.textContent = '‚ùå Reject';
        rejectBtn.addEventListener('click', () => changeStatus(r.docId, 'rejected'));

        const delBtn = document.createElement('button');
        delBtn.className = 'btn';
        delBtn.textContent = 'üóëÔ∏è Delete';
        delBtn.addEventListener('click', () => deleteWithReason(r.docId, r.email));

        actionsTd.appendChild(inProgressBtn);
        actionsTd.appendChild(completeBtn);
        actionsTd.appendChild(rejectBtn);
        actionsTd.appendChild(delBtn);

        tr.appendChild(actionsTd);

        reqTbody.appendChild(tr);
      });
    }

    // ---------- ACTIONS ----------
    async function changeStatus(docId, newStatus) {
      try {
        await updateDoc(doc(db, SERVICE_COLLECTION, docId), { status: newStatus });
        await addDoc(collection(db, APP_LOGS_COLLECTION), { action: `status:${newStatus}`, targetEmail: '-', performedBy: currentUser ? currentUser.email : 'unknown', reason: '', timestamp: new Date() });
        toast('Status updated to ' + newStatus, 'success', 2500);
        playBeep();
        // local update (optimistic)
        const idx = requests.findIndex(r => r.docId === docId);
        if(idx > -1) requests[idx].status = newStatus;
        renderTable();
      } catch(e) {
        console.error(e);
        toast('Update failed', 'error', 3000);
      }
    }

    async function deleteWithReason(docId, targetEmail) {
      const reason = prompt('Reason for deletion:');
      if(!reason || !reason.trim()){ toast('Deletion cancelled ‚Äî reason required', 'error', 2200); return; }
      try {
        await deleteDoc(doc(db, SERVICE_COLLECTION, docId));
        await addDoc(collection(db, APP_LOGS_COLLECTION), { action: 'deleted', targetEmail: targetEmail || '-', performedBy: currentUser ? currentUser.email : 'unknown', reason, timestamp: new Date() });
        toast('Request deleted', 'success', 2200);
      } catch(e) {
        console.error(e);
        toast('Delete failed', 'error', 2200);
      }
    }

    // bulk actions
    function getSelectedIds(){
      return Array.from(document.querySelectorAll('.row-checkbox:checked')).map(i => i.dataset.id);
    }

    selectAllBtn.addEventListener('click', () => {
      const boxes = document.querySelectorAll('.row-checkbox');
      const anyUnchecked = Array.from(boxes).some(b => !b.checked);
      boxes.forEach(b => b.checked = anyUnchecked);
    });

    markInProgressBulk.addEventListener('click', async () => {
      const ids = getSelectedIds();
      if(!ids.length){ toast('No rows selected', 'error'); return; }
      if(!confirm(`Mark ${ids.length} requests as In Progress?`)) return;
      for(const id of ids){
        try{ await updateDoc(doc(db, SERVICE_COLLECTION, id), { status: 'in progress' });
              await addDoc(collection(db, APP_LOGS_COLLECTION), { action:'status:in progress', targetEmail:'-', performedBy:currentUser?currentUser.email:'unknown', reason:'bulk', timestamp:new Date() });
        } catch(e){ console.error(e); }
      }
      toast('Bulk updated', 'success', 1800);
    });

    markCompleteBulk.addEventListener('click', async () => {
      const ids = getSelectedIds();
      if(!ids.length){ toast('No rows selected', 'error'); return; }
      if(!confirm(`Mark ${ids.length} requests as Completed?`)) return;
      for(const id of ids){
        try{ await updateDoc(doc(db, SERVICE_COLLECTION, id), { status: 'completed' });
              await addDoc(collection(db, APP_LOGS_COLLECTION), { action:'status:completed', targetEmail:'-', performedBy:currentUser?currentUser.email:'unknown', reason:'bulk', timestamp:new Date() });
        } catch(e){ console.error(e); }
      }
      toast('Bulk completed', 'success', 1800);
    });

    deleteBulkBtn.addEventListener('click', async () => {
      const ids = getSelectedIds();
      if(!ids.length){ toast('No rows selected', 'error'); return; }
      const reason = prompt(`Reason for deleting ${ids.length} requests:`);
      if(!reason) { toast('Bulk delete cancelled', 'error'); return; }
      if(!confirm(`Delete ${ids.length} requests? This is permanent.`)) return;
      for(const id of ids){
        try{ await deleteDoc(doc(db, SERVICE_COLLECTION, id));
              await addDoc(collection(db, APP_LOGS_COLLECTION), { action:'deleted', targetEmail:'-', performedBy:currentUser?currentUser.email:'unknown', reason, timestamp:new Date() });
        } catch(e){ console.error(e); }
      }
      toast('Bulk delete done', 'success', 2000);
    });

    // master checkbox handling
    masterCheckbox.addEventListener('change', (e) => {
      const checked = e.target.checked;
      document.querySelectorAll('.row-checkbox').forEach(b => b.checked = checked);
    });

    // search & tabs
    searchInput.addEventListener('input', () => renderTable());
    tabs.forEach(t => t.addEventListener('click', () => {
      tabs.forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      currentFilter = t.dataset.status;
      renderTable();
    }));

    // refresh button
    refreshBtn.addEventListener('click', async () => {
      toast('Refreshing...', 'info', 1200);
      await fetchAllRequests();
      await loadVisits();
    });

    // export CSV
    exportBtn.addEventListener('click', () => {
      if(!requests.length){ toast('No data to export', 'error'); return; }
      const rows = [
        ['Client Name','Email','Phone','Service Tags','Project Description','Status','Created At']
      ];
      requests.forEach(r => {
        rows.push([
          r.fullName || '',
          r.email || '',
          r.phone || '',
          (r.services||[]).join('; '),
          (r.motivation||'').replace(/\n/g,' '),
          r.status || '',
          r._createdAt ? r._createdAt.toLocaleString() : ''
        ]);
      });
      const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `service_requests_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      toast('CSV exported', 'success', 1400);
    });

    // logs view (super admin only)
    showLogsBtn.addEventListener('click', async () => {
      if(!isSuper){ toast('Admin logs require Super Admin', 'error'); return; }
      logsPanel.style.display = 'block';
      appLogsPanel.style.display = 'block';
      await loadAdminLogs();
      await loadAppLogs();
    });
    closeLogsBtn.addEventListener('click', () => logsPanel.style.display = 'none');
    closeAppLogsBtn.addEventListener('click', () => appLogsPanel.style.display = 'none');

    async function loadAdminLogs(){
      logsList.innerHTML = '<div style="color:var(--muted)">Loading admin logs...</div>';
      const snap = await getDocs(query(collection(db, ADMIN_LOGS_COLLECTION), orderBy('timestamp','desc')));
      logsList.innerHTML = '';
      snap.forEach(s => {
        const d = s.data();
        const date = d.timestamp && d.timestamp.seconds ? new Date(d.timestamp.seconds*1000).toLocaleString() : (d.timestamp ? new Date(d.timestamp).toLocaleString() : '-');
        const el = document.createElement('div');
        el.style.padding = '8px';
        el.style.borderBottom = '1px solid rgba(255,255,255,0.02)';
        el.innerHTML = `<div style="font-weight:700">${d.email}</div><div style="color:var(--muted); font-size:0.85rem">${d.ip||'-'} ‚Ä¢ ${date}</div><div style="font-size:0.85rem; color:var(--muted)">${d.userAgent||''}</div>`;
        logsList.appendChild(el);
      });
    }

    async function loadAppLogs(){
      appLogsList.innerHTML = '<div style="color:var(--muted)">Loading app logs...</div>';
      const snap = await getDocs(query(collection(db, APP_LOGS_COLLECTION), orderBy('timestamp','desc')));
      appLogsList.innerHTML = '';
      snap.forEach(s => {
        const d = s.data();
        const date = d.timestamp && d.timestamp.seconds ? new Date(d.timestamp.seconds*1000).toLocaleString() : (d.timestamp ? new Date(d.timestamp).toLocaleString() : '-');
        const el = document.createElement('div');
        el.style.padding = '8px';
        el.style.borderBottom = '1px solid rgba(255,255,255,0.02)';
        el.innerHTML = `<div style="font-weight:700">${d.action}</div><div style="color:var(--muted); font-size:0.85rem">Target: ${d.targetEmail||'-'} ‚Äî By: ${d.performedBy||'-'}</div><div style="color:var(--muted); font-size:0.85rem">${d.reason||''} ‚Ä¢ ${date}</div>`;
        appLogsList.appendChild(el);
      });
    }

    // toggle new alerts (mute/unmute)
    newRequestsToggle.addEventListener('click', () => {
      alertsEnabled = !alertsEnabled;
      newRequestsToggle.textContent = alertsEnabled ? 'üîî New Alerts' : 'üîï Alerts Off';
      toast('Alerts ' + (alertsEnabled ? 'enabled' : 'muted'), 'info', 1200);
    });

    // helper: when admin performs action, record app_log
    async function recordAppLog(action, targetEmail='-', reason='') {
      try{ await addDoc(collection(db, APP_LOGS_COLLECTION), { action, targetEmail, performedBy: currentUser?currentUser.email:'unknown', reason, timestamp: new Date() }); }
      catch(e){ console.error('log fail', e); }
    }

    // initial UI state
    document.getElementById('loginBox').style.display = 'block';

    // accessibility: keyboard enter login
    document.getElementById('adminPassword').addEventListener('keydown', e => { if(e.key === 'Enter') loginBtn.click(); });

  </script>
</body>
</html>


