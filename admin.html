<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CSQUARE¬≥ Agency ‚Äî Admin Dashboard</title>
  <style>
    :root{
      --deep-purple:#231123;
      --pink:#c30f45;
      --dark-bg:#0f0710;
      --card-bg: rgba(35,17,35,0.55);
      --glass: rgba(255,255,255,0.03);
      --accent: #c30f45;
      --text: #ffffff;
      --muted:#b9a7b6;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: "Poppins", sans-serif;
      background: linear-gradient(180deg,var(--dark-bg), #07030a 120%);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:24px;
    }

    .wrap{max-width:1200px;margin:0 auto;}

    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px;}
    .brand{display:flex;gap:12px;align-items:center;}
    .brand img{height:48px;width:auto;filter: drop-shadow(0 0 12px rgba(195,15,69,0.25));}
    .brand h1{font-size:1.1rem;margin:0;color:var(--text);letter-spacing:0.4px;font-weight:700;}
    .brand small{display:block;color:var(--muted);font-weight:600;font-size:0.8rem;margin-top:2px;}

    .controls{display:flex;gap:10px;align-items:center;}
    .btn{background: linear-gradient(135deg,var(--deep-purple), var(--pink));color:#fff;border:none;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700;display:inline-flex;gap:8px;align-items:center;}
    .btn.ghost{background: transparent;border:1px solid rgba(255,255,255,0.06);box-shadow:none;font-weight:600;}
    .btn.warn{background:var(--warning);color:#000;}
    .btn.danger{background:var(--danger);}

    .grid{display:grid;grid-template-columns: 1fr 380px;gap:18px;align-items:start;}
    .card{background: var(--card-bg);border:1px solid rgba(195,15,69,0.15);padding:16px;border-radius:14px;box-shadow: 0 8px 30px rgba(0,0,0,0.6);}

    .login-box{max-width:420px;margin:6vh auto;padding:22px;border-radius:14px;border:1px solid rgba(195,15,69,0.2);text-align:center;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));}
    .login-box h2{color:var(--pink);margin-bottom:8px;}
    .login-box input{width:100%;padding:10px 12px;margin:8px 0;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:#120814;color:var(--text);}

    .stats{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px;}
    .stat{flex:1;padding:12px;border-radius:10px;background: linear-gradient(135deg, rgba(195,15,69,0.06), rgba(195,15,69,0.03));border:1px solid rgba(195,15,69,0.06);text-align:center;}
    .stat h3{margin:0;font-size:1.05rem;color:var(--muted);}
    .stat p{margin:6px 0 0;font-size:1.4rem;font-weight:800;color:var(--text);}

    .top-controls{display:flex;gap:12px;margin-bottom:12px;align-items:center;}
    #searchInput{flex:1;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:#120814;color:var(--text);}
    .tabs{display:flex;gap:8px;padding:8px;}
    .tab{padding:8px 12px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.03);cursor:pointer;font-weight:700;color:var(--muted);}
    .tab.active{background:var(--pink);color:#fff;}

    .table-wrap{overflow:auto;margin-top:8px;}
    table{width:100%;border-collapse:collapse;min-width:900px;}
    th,td{padding:10px 8px;border-bottom:1px dashed rgba(255,255,255,0.02);text-align:left;font-size:0.95rem;vertical-align:middle;}
    th{color:var(--muted);font-size:0.85rem;background:rgba(0,0,0,0.02);}
    td.tags{max-width:260px;}
    .tag{display:inline-block;padding:6px 8px;border-radius:8px;background:rgba(195,15,69,0.12);color:var(--pink);font-weight:700;margin:2px 4px;font-size:0.8rem;}
    .action-btn{padding:6px 8px;border-radius:8px;border:none;cursor:pointer;margin-right:6px;font-weight:700;}
    .action-btn.inprogress{background:linear-gradient(90deg,#8b5cf6,#06b6d4);color:#fff;}
    .action-btn.complete{background:var(--success);color:#fff;}
    .action-btn.reject{background:var(--danger);color:#fff;}
    .action-btn.delete{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);}

    .right-col .section{margin-bottom:12px;}
    .small{font-size:0.85rem;color:var(--muted);}

    .small-table{width:100%;border-collapse:collapse;}
    .small-table th,.small-table td{padding:8px;border:1px solid rgba(255,255,255,0.03);font-size:0.85rem;}

    /* toasts top-right */
    .toasts{position:fixed;right:20px;top:20px;display:flex;flex-direction:column;gap:8px;z-index:9999;align-items:flex-end;}
    .toast{background:#111;border-left:4px solid var(--pink);padding:10px 12px;border-radius:8px;color:#fff;box-shadow:0 6px 20px rgba(0,0,0,0.6);min-width:220px;opacity:1;transition:transform .25s,opacity .25s;}
    .toast.success{border-left-color:var(--success);}
    .toast.warn{border-left-color:var(--warning);}
    .toast.hide{opacity:0;transform:translateY(-8px);}

    .muted{color:var(--muted)}
    .flex{display:flex;gap:8px;align-items:center;}
    .right{margin-left:auto}
    .center{text-align:center}
    @media (max-width:980px){
      .grid{grid-template-columns: 1fr;}
      table{min-width:720px;}
      .wrap{padding:12px;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img src="images/logo1.png" alt="logo">
        <div>
          <h1>CSQUARE¬≥ Agency ‚Äî Admin</h1>
          <small>Dashboard ‚Ä¢ Service Requests</small>
        </div>
      </div>

      <div class="controls">
        <button class="btn ghost" id="refreshBtn">üîÑ Refresh</button>
        <button class="btn" id="downloadBtn">‚¨áÔ∏è Export CSV</button>
        <button class="btn ghost" id="audioToggle">üîî Audio: ON</button>
        <button class="btn ghost" id="logoutBtn" style="display:none">Logout</button>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <div class="stats">
          <div class="stat"><h3>Service Requests</h3><p id="count">0</p></div>
          <div class="stat"><h3>Visitors</h3><p id="visitsCount">0</p></div>
          <div class="stat"><h3>Pending</h3><p id="pendingCount">0</p></div>
        </div>

        <div class="top-controls">
          <input id="searchInput" placeholder="üîç Search by client, email or service..." />
          <div class="tabs" id="tabs">
            <div class="tab active" data-status="all">All</div>
            <div class="tab" data-status="pending">Pending</div>
            <div class="tab" data-status="in_progress">In Progress</div>
            <div class="tab" data-status="completed">Completed</div>
            <div class="tab" data-status="graphic design">Graphic</div>
            <div class="tab" data-status="programming">Programming</div>
            <div class="tab" data-status="video editing">Video</div>
            <div class="tab" data-status="photography">Photo</div>
          </div>
        </div>

        <div class="table-wrap">
          <table id="requestsTable">
            <thead>
              <tr>
                <th>Client Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Service Tags</th>
                <th>Project Description</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="requestsBody"></tbody>
          </table>
        </div>
      </div>

      <div class="right-col">
        <div class="card section">
          <h3 style="margin-top:0">Quick Tools</h3>
          <p class="small">Use controls below for admin operations.</p>
          <div style="margin-top:10px" class="flex">
            <button class="btn" id="newRequestSeed">‚ûï Seed Test Request</button>
            <button class="btn ghost" id="clearAllBtn">üßπ Clear Display</button>
          </div>
        </div>

        <div class="card section">
          <h3 style="margin-top:0">Admin Logs</h3>
          <p class="small">Recent admin login activity</p>
          <div style="margin-top:10px;max-height:200px;overflow:auto;">
            <table class="small-table" id="adminLogsTable"><thead><tr><th>Email</th><th>IP</th><th>When</th></tr></thead><tbody></tbody></table>
          </div>
          <div style="margin-top:8px;font-size:0.85rem;color:var(--muted)">Only SUPER admin sees detailed logs.</div>
        </div>

        <div class="card section">
          <h3 style="margin-top:0">Application Logs</h3>
          <p class="small">Action history (delete/status updates)</p>
          <div style="margin-top:10px;max-height:200px;overflow:auto;">
            <table class="small-table" id="appLogsTable"><thead><tr><th>Action</th><th>Target</th><th>By</th><th>When</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- login modal -->
  <div id="loginModal" class="login-box" style="display:block;">
    <h2>Admin Login</h2>
    <input id="adminEmail" type="email" placeholder="admin email" />
    <input id="adminPassword" type="password" placeholder="password" />
    <div style="display:flex;gap:8px;justify-content:center;margin-top:8px;">
      <button class="btn" id="loginBtn">Login</button>
    </div>
    <p class="note">You need an admin account (Firebase Auth) to access.</p>
    <p id="loginError" style="color:#ff6b6b"></p>
  </div>

  <!-- toasts -->
  <div class="toasts" id="toasts"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, query, orderBy, onSnapshot,
      doc, updateDoc, deleteDoc, where, limit
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

    // Firebase config (unchanged)
    const firebaseConfig = {
      apiKey: "AIzaSyALCOPIyEyT3DNh0jOIIqRXQ-KTUolJh7k",
      authDomain: "csquare3-club.firebaseapp.com",
      projectId: "csquare3-club",
      storageBucket: "csquare3-club.firebasestorage.app",
      messagingSenderId: "910428386089",
      appId: "1:910428386089:web:4e5b10d7d23b818547fd38",
      measurementId: "G-6RTLYLFV11"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Super admin same as old
    const SUPER_ADMIN = "admin@csquare3.club";

    // DOM
    const loginModal = document.getElementById('loginModal');
    const loginBtn = document.getElementById('loginBtn');
    const adminEmailInput = document.getElementById('adminEmail');
    const adminPasswordInput = document.getElementById('adminPassword');
    const loginError = document.getElementById('loginError');

    const refreshBtn = document.getElementById('refreshBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const audioToggle = document.getElementById('audioToggle');
    const logoutBtn = document.getElementById('logoutBtn');

    const requestsBody = document.getElementById('requestsBody');
    const countEl = document.getElementById('count');
    const visitsCountEl = document.getElementById('visitsCount');
    const pendingCountEl = document.getElementById('pendingCount');

    const tabs = document.getElementById('tabs');
    const tabButtons = document.querySelectorAll('.tab');
    const searchInput = document.getElementById('searchInput');
    const adminLogsTable = document.getElementById('adminLogsTable').querySelector('tbody');
    const appLogsTable = document.getElementById('appLogsTable').querySelector('tbody');

    const newRequestSeed = document.getElementById('newRequestSeed');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const toasts = document.getElementById('toasts');

    // helpers
    function showToast(message, type='info', timeout=3500){
      const div = document.createElement('div');
      div.className = 'toast ' + (type==='success'?'success': type==='warn'?'warn':'');
      div.textContent = message;
      toasts.prepend(div);
      setTimeout(()=> { div.classList.add('hide'); setTimeout(()=>div.remove(),300); }, timeout);
    }

    let audioEnabled = true;
    audioToggle.addEventListener('click', () => {
      audioEnabled = !audioEnabled;
      audioToggle.textContent = audioEnabled ? 'üîî Audio: ON' : 'üîï Audio: OFF';
      showToast('Audio ' + (audioEnabled ? 'enabled' : 'disabled'), 'info', 1500);
    });
    function playBeep(type='short'){
      if(!audioEnabled) return;
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.value = (type==='short') ? 880 : 660;
        g.gain.value = 0.05;
        o.connect(g);
        g.connect(ctx.destination);
        o.start();
        setTimeout(()=> { o.stop(); ctx.close(); }, (type==='short')?120:360);
      } catch(e){}
    }

    // state
    let serviceRequests = [];
    let seenIds = new Set();
    let unsubscribeRequests = null;
    let currentFilter = 'all';

    // mark existing seen (so initial load doesn't beep)
    async function initialMarkSeen(){
      try{
        const q = query(collection(db, "serviceRequests"), orderBy("timestamp","desc"), limit(200));
        const snap = await getDocs(q);
        snap.forEach(d => seenIds.add(d.id));
      }catch(e){}
    }
    initialMarkSeen();

    // auth / login
    loginBtn.addEventListener('click', async () => {
      loginError.textContent = '';
      const email = adminEmailInput.value.trim();
      const password = adminPasswordInput.value.trim();
      if(!email || !password){ loginError.textContent = 'Enter email and password'; return; }
      try{
        const cred = await signInWithEmailAndPassword(auth, email, password);
        // log admin login
        try{
          const ip = await fetch('https://api.ipify.org?format=json').then(r=>r.json()).then(j=>j.ip).catch(()=> 'N/A');
          await addDoc(collection(db, 'admin_logs'), { email: cred.user.email, ip, timestamp: new Date(), userAgent: navigator.userAgent });
        }catch(e){}
        loginModal.style.display = 'none';
        document.getElementById('logoutBtn').style.display = 'inline-flex';
        showToast('Logged in as ' + cred.user.email, 'success', 2200);
      }catch(err){
        console.error(err);
        loginError.textContent = 'Invalid credentials or network error';
      }
    });

    // sign out
    logoutBtn.addEventListener('click', async ()=>{
      await signOut(auth);
      loginModal.style.display = 'block';
      document.getElementById('logoutBtn').style.display = 'none';
      showToast('Logged out', 'info', 1800);
      if(typeof unsubscribeRequests === 'function') unsubscribeRequests(); // stop listener
      serviceRequests = [];
      renderTable();
    });

    // onAuthStateChanged ‚Äî only subscribe when user exists
    onAuthStateChanged(auth, async (user) => {
      if(user){
        // hide login
        loginModal.style.display = 'none';
        document.getElementById('logoutBtn').style.display = 'inline-flex';
        // show logs only if super admin
        if(user.email === SUPER_ADMIN){
          // load admin logs + app logs
          loadAdminLogs();
          loadAppLogs();
        }
        setupRealtimeListener();
        loadVisitsCount();
      } else {
        // show login modal
        loginModal.style.display = 'block';
        document.getElementById('logoutBtn').style.display = 'none';
        if(typeof unsubscribeRequests === 'function') unsubscribeRequests();
      }
    });

    // realtime listener
    function setupRealtimeListener(){
      if(typeof unsubscribeRequests === 'function') unsubscribeRequests();
      const q = query(collection(db, "serviceRequests"), orderBy("timestamp","desc"));
      unsubscribeRequests = onSnapshot(q, (snap) => {
        const docs = [];
        let newDetected = false;
        let statusChangedCount = 0;
        const prevStatus = new Map(serviceRequests.map(r=>[r.id, r.status]));
        snap.forEach(docSnap => {
          const d = docSnap.data();
          d.id = docSnap.id;
          // normalize status field
          d.status = d.status || 'pending';
          docs.push(d);
          if(!seenIds.has(d.id)){
            seenIds.add(d.id);
            newDetected = true;
          }
        });

        // detect status changes
        docs.forEach(d => {
          const before = prevStatus.get(d.id);
          if(before && before !== d.status) statusChangedCount++;
        });

        serviceRequests = docs;
        renderTable();

        if(newDetected){
          showToast('New service request received ‚úÖ', 'success', 3500);
          playBeep('short');
        }
        if(statusChangedCount > 0){
          showToast('Some request statuses changed ‚öôÔ∏è', 'info', 3000);
          playBeep('long');
        }
        updateStats();
      }, (err)=> {
        console.error('Listener error', err);
        showToast('Realtime listener failed', 'warn', 3000);
      });
    }

    // render table safely and attach handlers using event delegation
    function renderTable(){
      const q = (searchInput.value || '').toLowerCase().trim();
      const filtered = serviceRequests.filter(r=>{
        // top-level filter by tab status or tag
        if(currentFilter !== 'all'){
          // if filter is one of tag names (graphic design etc.)
          const tagsLower = (r.serviceTags || []).map(t=>t.toLowerCase());
          if(['graphic design','programming','video editing','photography'].includes(currentFilter)){
            if(!tagsLower.some(t => t.includes(currentFilter.split(' ')[0]))) return false;
          } else {
            if((r.status || 'pending') !== currentFilter) return false;
          }
        }
        if(!q) return true;
        return (r.clientName && r.clientName.toLowerCase().includes(q))
               || (r.email && r.email.toLowerCase().includes(q))
               || (r.serviceTags && r.serviceTags.join(', ').toLowerCase().includes(q))
               || (r.projectDescription && r.projectDescription.toLowerCase().includes(q));
      });

      const tbody = requestsBody;
      tbody.innerHTML = '';
      filtered.forEach(r=>{
        const tr = document.createElement('tr');
        const tagsHtml = (r.serviceTags || []).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join(' ');
        tr.innerHTML = `
          <td>${escapeHtml(r.clientName || '-')}</td>
          <td>${escapeHtml(r.email || '-')}</td>
          <td>${escapeHtml(r.phone || '-')}</td>
          <td class="tags">${tagsHtml}</td>
          <td style="max-width:260px">${escapeHtml(truncate(r.projectDescription || '-', 200))}</td>
          <td style="font-weight:800;text-transform:capitalize">${statusBadge(r.status || 'pending')}</td>
          <td>
            <button class="action-btn inprogress" data-id="${r.id}" data-action="in_progress" title="Mark In Progress">‚ñ∂Ô∏è</button>
            <button class="action-btn complete" data-id="${r.id}" data-action="completed" title="Mark Completed">‚úîÔ∏è</button>
            <button class="action-btn reject" data-id="${r.id}" data-action="rejected" title="Reject">‚ùå</button>
            <button class="action-btn delete" data-id="${r.id}" data-action="deleted" title="Delete">üóëÔ∏è</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      // update visible counts
      countEl.textContent = serviceRequests.length;
      pendingCountEl.textContent = serviceRequests.filter(s=> (s.status||'pending') === 'pending').length;
    }

    // event delegation for action buttons (works after every render)
    requestsBody.addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-id]');
      if(!btn) return;
      const id = btn.dataset.id;
      const action = btn.dataset.action;
      const req = serviceRequests.find(r=>r.id === id);
      if(!req){ showToast('Request not found', 'warn'); return; }

      if(action === 'deleted'){
        const reason = prompt('Reason for deletion (required):');
        if(!reason || !reason.trim()){ alert('Deletion cancelled ‚Äî reason is required.'); return; }
        try{
          await deleteDoc(doc(db, 'serviceRequests', id));
          await addDoc(collection(db, 'app_logs'), { action: 'deleted', targetEmail: req.email || null, performedBy: auth.currentUser ? auth.currentUser.email : 'unknown', reason: reason.trim(), timestamp: new Date() });
          showToast('Request deleted', 'warn', 2500);
        }catch(e){ console.error(e); showToast('Delete failed', 'warn', 2000); }
        return;
      }

      // status changes
      try{
        await updateDoc(doc(db, 'serviceRequests', id), { status: action });
        await addDoc(collection(db, 'app_logs'), { action: 'status_update', targetEmail: req.email || null, performedBy: auth.currentUser ? auth.currentUser.email : 'unknown', reason: `status set to ${action}`, timestamp: new Date() });
        showToast('Status updated', 'success', 1800);
      }catch(e){ console.error(e); showToast('Update failed', 'warn', 2200); }
    });

    // status badge
    function statusBadge(s){
      const map = {
        pending: `<span style="color:${getComputedStyle(document.documentElement).getPropertyValue('--muted')};">Pending</span>`,
        in_progress: `<span style="color:#06b6d4;font-weight:800">In Progress</span>`,
        completed: `<span style="color:${getComputedStyle(document.documentElement).getPropertyValue('--success')}; font-weight:800">Completed</span>`,
        rejected: `<span style="color:${getComputedStyle(document.documentElement).getPropertyValue('--danger')}; font-weight:800">Rejected</span>`
      };
      return map[s] || `<span style="color:var(--muted)">${escapeHtml(s || '')}</span>`;
    }

    // search & tabs
    searchInput.addEventListener('input', renderTable);
    document.querySelectorAll('.tab').forEach(t=>{
      t.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        currentFilter = t.dataset.status;
        renderTable();
      });
    });

    // export CSV
    downloadBtn.addEventListener('click', ()=> {
      const rows = [['Client Name','Email','Phone','Service Tags','Project Description','Status','Timestamp']];
      serviceRequests.forEach(r=>{
        rows.push([
          r.clientName || '',
          r.email || '',
          r.phone || '',
          (r.serviceTags || []).join('; '),
          (r.projectDescription || '').replace(/\n/g,' '),
          r.status || 'pending',
          r.timestamp ? (r.timestamp.seconds ? new Date(r.timestamp.seconds*1000).toLocaleString() : new Date(r.timestamp).toLocaleString()) : ''
        ]);
      });
      const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'serviceRequests_export.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast('CSV exported', 'success');
    });

    // visits count
    async function loadVisitsCount(){
      try{
        const snap = await getDocs(collection(db, 'visits'));
        visitsCountEl.textContent = snap.size;
      }catch(e){}
    }

    // admin logs / app logs (latest 10)
    async function loadAdminLogs(){
      try{
        const q = query(collection(db, 'admin_logs'), orderBy('timestamp','desc'));
        const snap = await getDocs(q);
        adminLogsTable.innerHTML = '';
        let c=0;
        snap.forEach(d=>{
          if(c++ > 10) return;
          const l=d.data();
          const when = l.timestamp ? (l.timestamp.seconds ? new Date(l.timestamp.seconds*1000).toLocaleString() : new Date(l.timestamp).toLocaleString()) : '-';
          const tr = document.createElement('tr');
          tr.innerHTML = `<td style="font-weight:700">${escapeHtml(l.email||'-')}</td><td>${escapeHtml(l.ip||'-')}</td><td>${when}</td>`;
          adminLogsTable.appendChild(tr);
        });
      }catch(e){ console.error(e); }
    }

    async function loadAppLogs(){
      try{
        const q = query(collection(db, 'app_logs'), orderBy('timestamp','desc'));
        const snap = await getDocs(q);
        appLogsTable.innerHTML = '';
        let c=0;
        snap.forEach(d=>{
          if(c++ > 10) return;
          const l=d.data();
          const when = l.timestamp ? (l.timestamp.seconds ? new Date(l.timestamp.seconds*1000).toLocaleString() : new Date(l.timestamp).toLocaleString()) : '-';
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${escapeHtml(l.action||'-')}</td><td>${escapeHtml(l.targetEmail||'-')}</td><td>${escapeHtml(l.performedBy||'-')}</td><td>${when}</td>`;
          appLogsTable.appendChild(tr);
        });
      }catch(e){ console.error(e); }
    }

    // refresh button
    refreshBtn.addEventListener('click', async ()=>{
      showToast('Refreshing...', 'info', 1000);
      if(typeof unsubscribeRequests === 'function') unsubscribeRequests();
      setupRealtimeListener();
      loadVisitsCount();
      loadAdminLogs();
      loadAppLogs();
    });

    // seed test
    newRequestSeed.addEventListener('click', async () => {
      try{
        await addDoc(collection(db, 'serviceRequests'), {
          clientName: 'Test Client ' + Math.floor(Math.random()*999),
          email: 'test+'+Math.floor(Math.random()*999)+'@example.com',
          phone: '+2136' + Math.floor(10000000 + Math.random()*89999999),
          serviceTags: ['Graphic Design : Logo Design'],
          projectDescription: 'This is a seeded test request.',
          status: 'pending',
          timestamp: new Date()
        });
        showToast('Test request added', 'success', 1800);
      }catch(e){ console.error(e); showToast('Seed failed', 'warn'); }
    });

    clearAllBtn.addEventListener('click', ()=> { requestsBody.innerHTML = ''; showToast('Display cleared', 'info', 1200); });

    // utilities
    function escapeHtml(str){ return String(str || '').replace(/[&<>"'`]/g, (s)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;' }[s])); }
    function truncate(s, n){ return s.length>n ? s.slice(0,n-1)+'‚Ä¶' : s; }

    // ensure cleanup
    window.addEventListener('beforeunload', ()=> { if(typeof unsubscribeRequests === 'function') unsubscribeRequests(); });

  </script>
</body>
</html>
